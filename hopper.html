<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kalvi Kraft Hopper</title>
    <link rel="icon" type="image/png" href="assets/logo.png" />
    <meta name="description" content="Kalvi Kraft Hopper - quick reflex arcade game embedded in Kalvi Kraft" />
    <style>
      :root{--bg:#062c3a;--panel:#02121b;--muted:#c6d4df;--accent:#4f46e5}
      *{box-sizing:border-box}
      body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#073241,#02121b);color:#e6eef6}
      .container{display:grid;grid-template-columns:260px 1fr 280px;gap:18px;max-width:1200px;margin:20px auto;padding:12px}
      .ads,.sidebar{background:transparent}
      .ad{margin-bottom:18px}
      main.content{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;min-height:640px}
      .gameWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
      .gameBox{width:100%;max-width:820px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#0b3447,#02121b);position:relative}
      canvas{width:100%;height:480px;display:block}
      .hudRow{display:flex;gap:12px;align-items:center;width:100%;justify-content:space-between}
      .stat{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;color:var(--muted);font-weight:700}
      .controls{display:flex;gap:10px}
      button{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}
      button.primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff;border:0}
      .muted{color:var(--muted)}
      .footerNote{font-size:12px;color:var(--muted);margin-top:10px}
      .leaderboard{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:var(--muted)}
      @media (max-width:980px){.container{grid-template-columns:1fr;}.ads{display:none}.sidebar{display:none}}
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Left Ads -->
      <aside class="ads">
        <div class="ad">
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6602675729982728" crossorigin="anonymous"></script>
          <!-- kalvikraft 1 -->
          <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6602675729982728" data-ad-slot="9131927510" data-ad-format="auto" data-full-width-responsive="true"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
        <div class="ad">
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6602675729982728" crossorigin="anonymous"></script>
          <!-- kalvikraft2 -->
          <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6602675729982728" data-ad-slot="2215165376" data-ad-format="auto" data-full-width-responsive="true"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
      </aside>

      <!-- Main -->
      <main class="content">
        <h2 style="margin:6px 0 12px 0">Kalvi Kraft Hopper</h2>
        <div class="gameWrap">
          <div class="hudRow">
            <div style="display:flex;gap:8px;align-items:center">
              <div class="stat">Score: <span id="score">0</span></div>
              <div class="stat">High: <span id="high">0</span></div>
              <div class="stat">Combo: <span id="combo">x1</span></div>
            </div>
            <div class="controls">
              <button id="muteBtn">ðŸ”Š</button>
              <button id="musicBtn">ðŸŽµ</button>
              <button id="restartBtn" class="primary">Restart</button>
            </div>
          </div>

          <div class="gameBox">
            <canvas id="gameCanvas" width="960" height="540"></canvas>
            <div id="overlay" style="position:absolute;right:12px;top:12px;color:var(--muted);text-align:right"></div>
            <div id="hudMsg" style="position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.25);padding:6px 8px;border-radius:8px;color:#fff;font-weight:700"></div>
          </div>

          <div style="display:flex;gap:12px;width:100%;align-items:flex-start">
            <div style="flex:1">
              <p class="muted">How to play: Tap / Click / Space to jump. While midair, click/tap again for a slow secondary jump (shorter). You cannot jump past the top. Avoid obstacles and rack up combos.</p>
              <p class="footerNote">Scores are saved locally and synced to Kalvi Kraft leaderboard (Firebase).</p>
            </div>
            <div style="width:220px">
              <div class="leaderboard">
                <h4 style="margin:6px 0">Top Scores</h4>
                <table style="width:100%;color:var(--muted);font-weight:700" id="lbTable">
                  <thead><tr><td>#</td><td>Name</td><td style="text-align:right">Score</td></tr></thead>
                  <tbody id="lbBody"><tr><td colspan="3">Loading...</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Sidebar (Leaderboard + notifications placeholder) -->
      <aside class="sidebar">
        <div style="background:transparent;padding:0">
          <div style="margin-bottom:18px">
            <div class="ad">
              <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6602675729982728" crossorigin="anonymous"></script>
              <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6602675729982728" data-ad-slot="9131927510" data-ad-format="auto" data-full-width-responsive="true"></ins>
              <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
          </div>

          <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;color:var(--muted)">
            <h4 style="margin:6px 0">Notifications</h4>
            <ul id="notification-list"><li>Loading...</li></ul>
          </div>
        </div>
      </aside>
    </div>

    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <script>
      // Firebase config from your index
      const firebaseConfig = {
        apiKey: 'AIzaSyAGrQ2f94bl5bbQzqTM_fU0xwnRCusQN14',
        authDomain: 'kalvi-kraft.firebaseapp.com',
        databaseURL:
          'https://kalvi-kraft-default-rtdb.asia-southeast1.firebasedatabase.app',
        projectId: 'kalvi-kraft',
        storageBucket: 'kalvi-kraft.appspot.com',
        messagingSenderId: '535767835272',
        appId: '1:535767835272:web:56d04e7c7d6f611194753d',
        measurementId: 'G-S1YJCR79MN',
      };
      firebase.initializeApp(firebaseConfig);

      // Leaderboard helper
      function fetchLeaderboard(){
        const lbBody = document.getElementById('lbBody');
        lbBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
        firebase.database().ref('leaderboard').once('value').then(snapshot=>{
          const arr = [];
          snapshot.forEach(child=> arr.push(child.val()));
          arr.sort((a,b)=>b.score - a.score);
          lbBody.innerHTML = '';
          arr.slice(0,10).forEach((it,idx)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="width:28px">${idx+1}</td><td>${escapeHtml(it.name||'Anon')}</td><td style="text-align:right">${it.score}</td>`;
            lbBody.appendChild(tr);
          });
          if(arr.length===0) lbBody.innerHTML = '<tr><td colspan="3">No scores yet</td></tr>';
        }).catch(()=>{ lbBody.innerHTML = '<tr><td colspan="3">Failed to load</td></tr>'; });
      }

      function pushScoreToFirebase(name,score){
        const ref = firebase.database().ref('leaderboard');
        const entry = { name: name || 'Anon', score: Number(score) };
        // push as child with unique key
        ref.push(entry).then(()=> fetchLeaderboard()).catch(()=> console.warn('Leaderboard push failed'));
      }

      // load notifications (attempt same file path as your index)
      fetch('json/notifications.json').then(r=>r.json()).then(data=>{
        const list = document.getElementById('notification-list'); list.innerHTML=''; data.slice(0,5).forEach(item=>{
          const li = document.createElement('li'); li.textContent = item.message; list.appendChild(li);
        });
      }).catch(()=>{ document.getElementById('notification-list').innerHTML='<li>Failed to load notifications.</li>' });

      // --- GAME CODE ---
      (function(){
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        let scoreEl = document.getElementById('score');
        let highEl = document.getElementById('high');
        let comboEl = document.getElementById('combo');
        let overlay = document.getElementById('overlay');
        let hudMsg = document.getElementById('hudMsg');
        const restartBtn = document.getElementById('restartBtn');
        const muteBtn = document.getElementById('muteBtn');
        const musicBtn = document.getElementById('musicBtn');

        // audio & music
        let muted = localStorage.getItem('kk_muted') === 'true';
        let musicOn = false;
        muteBtn.textContent = muted ? 'ðŸ”‡' : 'ðŸ”Š';
        musicBtn.textContent = 'ðŸŽµ';

        // state
        let running = true; let gameOver = false;
        let score = 0; let high = parseInt(localStorage.getItem('kk_hs')||'0',10) || 0; highEl.textContent = high;
        let combo = 1; let comboTimer = 0;

        // player
        const player = { x:140, y:H-80, vy:0, r:20, onGround:false, usedMidJump:false };
        const gravity = 0.95;
        const TOP_LIMIT = 48; // cannot go above this y

        // obstacles
        let obstacles = []; let spawnTimer = 60; let baseSpeed = 3.2; let speed = baseSpeed; let frames = 0;
        let particles = [];

        // music oscillator (simple loop) - optional
        let audioCtx=null, musicOsc=null, musicGain=null;
        function startMusic(){ if(musicOn||muted) return; try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); musicOsc = audioCtx.createOscillator(); musicGain = audioCtx.createGain(); musicOsc.type='sine'; musicOsc.frequency.value = 220; musicGain.gain.value = 0.0015; musicOsc.connect(musicGain); musicGain.connect(audioCtx.destination); musicOsc.start(); musicOn=true; }catch(e){} }
        function stopMusic(){ try{ if(musicOsc) musicOsc.stop(); musicOsc=null; if(musicGain) musicGain.disconnect(); musicGain=null; if(audioCtx) audioCtx.close(); audioCtx=null; musicOn=false;}catch(e){} }

        // helpers
        function rand(a,b){return a + Math.random()*(b-a)}
        function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
        function playTone(freq,dur,vol=0.06){ if(muted) return; try{ const ctxA = window.__audioCtx || (window.__audioCtx = new (window.AudioContext||window.webkitAudioContext)()); const o = ctxA.createOscillator(); const g = ctxA.createGain(); o.type='sine'; o.frequency.value = freq; g.gain.value = vol; o.connect(g); g.connect(ctxA.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctxA.currentTime + dur/1000); o.stop(ctxA.currentTime + dur/1000 + 0.02);}catch(e){}
        }

        // spawn obstacle
        function spawn(){ const h = rand(36,120); const type = Math.random()<0.62 ? 'bench' : 'books'; const w = type==='bench'?70:48; obstacles.push({x:W+40,w,h,type,passed:false}); }

        // restart
        function restart(){ score=0; combo=1; comboTimer=0; obstacles=[]; particles=[]; player.y=H-80; player.vy=0; player.usedMidJump=false; speed=baseSpeed; gameOver=false; running=true; frames=0; spawnTimer=60; hudMsg.textContent='Ready! Click or press Space to start'; }

        restartBtn.addEventListener('click', ()=>{ restart(); });
        muteBtn.addEventListener('click', ()=>{ muted = !muted; localStorage.setItem('kk_muted', muted); muteBtn.textContent = muted ? 'ðŸ”‡' : 'ðŸ”Š'; if(muted) stopMusic(); });
        musicBtn.addEventListener('click', ()=>{ if(musicOn){ stopMusic(); } else { startMusic(); } });

        // input: single jump + slower second jump while midair
        function jump(){
          if(gameOver){ onGameOverClick(); return; }
          // first jump only if on ground
          if(player.onGround){ player.vy = -13; player.onGround=false; player.usedMidJump=false; playTone(560,70,0.06); }
          else if(!player.usedMidJump){ // mid-air secondary slower jump
            player.vy = -7.5; player.usedMidJump = true; playTone(360,80,0.05); // smaller thrust
            // small particle burst
            for(let i=0;i<8;i++) particles.push({x:player.x,y:player.y,vx:rand(-2,2),vy:rand(-4,-1),life:30,sz:2});
          }
        }
        window.addEventListener('keydown', e=>{ if(e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); jump(); } });
        canvas.addEventListener('pointerdown', ()=> jump());

        // collision helper
        function rectIntersect(px,py,r,ox,oy,ow,oh){ const closestX = Math.max(ox, Math.min(px, ox+ow)); const closestY = Math.max(oy, Math.min(py, oy+oh)); const dx = px - closestX, dy = py - closestY; return (dx*dx + dy*dy) < (r*r); }

        function createExplosion(x,y,count){ for(let i=0;i<count;i++) particles.push({x,y,vx:rand(-6,6),vy:rand(-6,6),life:rand(20,60),sz:rand(2,5)}); }

        // game over handler: ask for name and push to firebase if big score
        function onGameOverClick(){
          running=false;
          // offer to save score if > 0
          if(score>0){ const prevBest = parseInt(localStorage.getItem('kk_hs')||'0',10) || 0; if(score>prevBest) localStorage.setItem('kk_hs', Math.floor(score));
            setTimeout(()=>{
              const name = prompt('Game over! Enter your name for leaderboard (or leave blank):','Player');
              if(name !== null){ pushScoreToFirebase(name || 'Anon', Math.floor(score)); }
            }, 120);
          }
        }

        // update logic
        function update(){
          if(!running || gameOver) return;
          frames++;
          // difficulty ramps
          speed = baseSpeed + Math.min(frames/1200, 5);
          // spawn timer depends on speed
          spawnTimer -= 1 + Math.min(score/200, 1.6);
          if(spawnTimer <= 0){ spawn(); spawnTimer = Math.max(36, Math.floor(rand(48 - Math.min(frames/600,20), 110 - Math.min(frames/600,30)))); }

          // player physics
          player.vy += gravity; player.y += player.vy; player.angle = player.vy * 0.02;
          // top restriction
          if(player.y < TOP_LIMIT){ player.y = TOP_LIMIT; player.vy = Math.max(0, player.vy); }
          // ground
          if(player.y + player.r > H - 28){ player.y = H - 28 - player.r; player.vy = 0; player.onGround = true; player.usedMidJump = false; } else player.onGround = false;

          // obstacles
          for(let i=obstacles.length-1;i>=0;i--){ const ob = obstacles[i]; ob.x -= speed; if(!ob.passed && ob.x + ob.w < player.x){ ob.passed = true; score += Math.floor(12 * combo); combo += 0.18; comboTimer = 110; playTone(260+Math.min(score,1200),50,0.04); }
            if(ob.x + ob.w < -80) obstacles.splice(i,1);
            // collision detection
            if(rectIntersect(player.x, player.y, player.r, ob.x, H - 28 - ob.h, ob.w, ob.h)){
              const landingThreshold = 3.5; const topY = H - 28 - ob.h - player.r;
              if(player.vy > landingThreshold && player.y < topY + player.r*0.6){ gameOver = true; running=false; playTone(120,260,0.2); createExplosion(player.x, player.y, 30); hudMsg.textContent='Game Over - click to save & restart'; }
              else { score += Math.floor(30 * combo); comboTimer = 120; playTone(760,90,0.06); player.vy = -9; particles.push({x:player.x,y:player.y,vx:rand(-1,1),vy:rand(-3,-1),life:28,sz:3}); }
            }
          }

          // combo decay
          if(comboTimer>0) comboTimer--; else combo = Math.max(1, combo - 0.04);

          // particles
          for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.vy += 0.25; p.x += p.vx; p.y += p.vy; p.life--; if(p.life<=0) particles.splice(i,1); }

          // score gain
          if(running && !gameOver) score += 0.16 * Math.max(1, combo);

          // update UI
          scoreEl.textContent = Math.floor(score);
          comboEl.textContent = 'x' + Math.max(1, combo.toFixed(1));
          const sc = Math.floor(score); if(sc>high){ high = sc; highEl.textContent = high; localStorage.setItem('kk_hs', high); }
        }

        // draw
        function draw(){ ctx.clearRect(0,0,W,H);
          // background
          const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0b4b5f'); g.addColorStop(1,'#02202b'); ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
          // ground
          ctx.fillStyle = '#0b2730'; ctx.fillRect(0,H-28,W,28);

          // obstacles
          obstacles.forEach(ob=>{ const ox = ob.x, oy = H - 28 - ob.h; if(ob.type==='bench'){ ctx.fillStyle='#8b5e3c'; ctx.fillRect(ox,oy,ob.w,ob.h); ctx.fillStyle='#5b3e2b'; ctx.fillRect(ox,oy+ob.h-8,ob.w,8); ctx.fillStyle='#2b1f16'; ctx.fillRect(ox+6,oy+ob.h,8,12); ctx.fillRect(ox+ob.w-14,oy+ob.h,8,12); } else { for(let i=0;i<3;i++){ const hh=ob.h/3; ctx.fillStyle=`hsl(${30+i*20},60%,${40 - i*6}%)`; ctx.fillRect(ox,oy + i*hh,ob.w,hh-3); ctx.strokeStyle='rgba(0,0,0,0.18)'; ctx.strokeRect(ox,oy + i*hh,ob.w,hh-3); } } });

          // player shadow
          ctx.save(); ctx.globalAlpha=0.22; ctx.fillStyle='#000'; ctx.beginPath(); ctx.ellipse(player.x+6,H-28 - player.r/2 + 6,player.r*1.1,player.r*0.45,0,0,Math.PI*2); ctx.fill(); ctx.restore();

          // player
          ctx.save(); ctx.translate(player.x,player.y); ctx.rotate((player.vy||0)*0.02); ctx.beginPath(); ctx.fillStyle='#ffd75a'; ctx.arc(0,0,player.r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#2b3440'; ctx.fillRect(-player.r*0.55,-player.r*0.6,player.r*1.1,player.r*0.32); ctx.restore();

          // particles
          particles.forEach(p=>{ ctx.globalAlpha = Math.max(0,p.life/60); ctx.beginPath(); ctx.fillStyle = p.col||'#ffd04b'; ctx.arc(p.x,p.y,p.sz,0,Math.PI*2); ctx.fill(); });

          overlay.innerHTML = `Speed: ${speed.toFixed(2)} <br> Obstacles: ${obstacles.length}`;

          if(gameOver){ ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.font='700 36px Inter, Roboto'; ctx.textAlign='center'; ctx.fillText('Game Over', W/2, H/2 - 20); ctx.font='600 18px Inter, Roboto'; ctx.fillText('Click to save score and restart', W/2, H/2 + 18); }
        }

        // RAF loop always draws so UI responsive
        (function loop(){ update(); draw(); requestAnimationFrame(loop); })();

        // click while game over -> save & restart
        canvas.addEventListener('pointerdown', ()=>{
          if(gameOver){
            // save and restart flow
            const name = prompt('Enter name to save score (or Cancel to skip):','Player');
            if(name !== null){ if(Math.floor(score)>0) pushScoreToFirebase(name || 'Anon', Math.floor(score)); }
            restart();
          }
        });

        // expose restart on global for other controls if needed
        window.kk_restart = restart;

      })();

      // small util for escaping
      function escapeHtml(unsafe){ return unsafe.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]; }); }

      // initially fetch leaderboard
      fetchLeaderboard();
    </script>
  </body>
</html>
