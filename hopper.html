<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalvi Kraft Hopper</title>
  <link rel="icon" type="image/png" href="assets/logo.png" />
  <meta name="description" content="Kalvi Kraft Hopper - quick reflex arcade game embedded in Kalvi Kraft" />
  <style>
    :root{--bg:#062c3a;--panel:#02121b;--muted:#c6d4df;--accent:#4f46e5}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#073241,#02121b);color:#e6eef6}
    .container{display:grid;grid-template-columns:260px 1fr 280px;gap:18px;max-width:1200px;margin:20px auto;padding:12px}
    .ads,.sidebar{background:transparent}
    .ad{margin-bottom:18px}
    main.content{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;min-height:640px}
    .gameWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .gameBox{width:100%;max-width:920px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#0b3447,#02121b);position:relative}
    canvas{width:100%;height:540px;display:block;background:#03111a}
    .hudRow{display:flex;gap:12px;align-items:center;width:100%;justify-content:space-between}
    .stat{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;color:var(--muted);font-weight:700}
    .controls{display:flex;gap:10px}
    button{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff;border:0}
    .muted{color:var(--muted)}
    .footerNote{font-size:12px;color:var(--muted);margin-top:10px}
    .leaderboard{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:var(--muted)}
    @media (max-width:980px){.container{grid-template-columns:1fr;}.ads{display:none}.sidebar{display:none}}
  </style>
</head>
<body>
  <div class="container">
    <!-- Left Ads -->
    <aside class="ads">
      <div class="ad">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6602675729982728" crossorigin="anonymous"></script>
        <!-- kalvikraft 1 -->
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6602675729982728" data-ad-slot="9131927510" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>
      <div class="ad">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6602675729982728" crossorigin="anonymous"></script>
        <!-- kalvikraft2 -->
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6602675729982728" data-ad-slot="2215165376" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>
    </aside>

    <!-- Main -->
    <main class="content">
      <h2 style="margin:6px 0 12px 0">Kalvi Kraft Hopper</h2>
      <div class="gameWrap">
        <div class="hudRow">
          <div style="display:flex;gap:8px;align-items:center">
            <div class="stat">Score: <span id="score">0</span></div>
            <div class="stat">High: <span id="high">0</span></div>
            <div class="stat">Combo: <span id="combo">x1</span></div>
          </div>
          <div class="controls">
            <button id="muteBtn">ðŸ”Š</button>
            <button id="restartBtn" class="primary">Restart</button>
          </div>
        </div>

        <div class="gameBox">
          <canvas id="gameCanvas" width="960" height="540"></canvas>
          <div id="overlay" style="position:absolute;right:12px;top:12px;color:var(--muted);text-align:right"></div>
          <div id="hudMsg" style="position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.25);padding:6px 8px;border-radius:8px;color:#fff;font-weight:700"></div>
        </div>

        <div style="display:flex;gap:12px;width:100%;align-items:flex-start">
          <div style="flex:1">
            <p class="muted">How to play: Tap / Click / Space to jump. You have up to <strong>4 jumps</strong> in midair â€” each jump is shorter than the previous. You cannot jump past the top. Avoid obstacles and rack up combos.</p>
            <p class="footerNote">Scores are saved locally and synced to Kalvi Kraft leaderboard (Firebase).</p>
          </div>
          <div style="width:220px">
            <div class="leaderboard">
              <h4 style="margin:6px 0">Top Scores</h4>
              <table style="width:100%;color:var(--muted);font-weight:700" id="lbTable">
                <thead><tr><td>#</td><td>Name</td><td style="text-align:right">Score</td></tr></thead>
                <tbody id="lbBody"><tr><td colspan="3">Loading...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="sidebar">
      <div style="background:transparent;padding:0">
        <div style="margin-bottom:18px">
          <div class="ad">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6602675729982728" crossorigin="anonymous"></script>
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6602675729982728" data-ad-slot="9131927510" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;color:var(--muted)">
          <h4 style="margin:6px 0">Notifications</h4>
          <ul id="notification-list"><li>Loading...</li></ul>
        </div>
      </div>
    </aside>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config (from your index)
    const firebaseConfig = {
      apiKey: 'AIzaSyAGrQ2f94bl5bbQzqTM_fU0xwnRCusQN14',
      authDomain: 'kalvi-kraft.firebaseapp.com',
      databaseURL: 'https://kalvi-kraft-default-rtdb.asia-southeast1.firebasedatabase.app',
      projectId: 'kalvi-kraft',
      storageBucket: 'kalvi-kraft.appspot.com',
      messagingSenderId: '535767835272',
      appId: '1:535767835272:web:56d04e7c7d6f611194753d',
      measurementId: 'G-S1YJCR79MN'
    };
    firebase.initializeApp(firebaseConfig);

    // leaderboard helpers
    function fetchLeaderboard(){
      const lbBody = document.getElementById('lbBody');
      lbBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
      firebase.database().ref('leaderboard').once('value').then(snapshot=>{
        const arr = [];
        snapshot.forEach(child=> arr.push(child.val()));
        arr.sort((a,b)=>b.score - a.score);
        lbBody.innerHTML = '';
        arr.slice(0,10).forEach((it,idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = '<td style="width:28px">'+(idx+1)+'</td><td>'+escapeHtml(it.name||'Anon')+'</td><td style="text-align:right">'+it.score+'</td>';
          lbBody.appendChild(tr);
        });
        if(arr.length===0) lbBody.innerHTML = '<tr><td colspan="3">No scores yet</td></tr>';
      }).catch(()=>{ lbBody.innerHTML = '<tr><td colspan="3">Failed to load</td></tr>'; });
    }
    function pushScoreToFirebase(name,score){
      const ref = firebase.database().ref('leaderboard');
      const entry = { name: name || 'Anon', score: Number(score) };
      ref.push(entry).then(()=> fetchLeaderboard()).catch(()=> console.warn('Leaderboard push failed'));
    }

    // notifications (same path as your index)
    fetch('json/notifications.json').then(r=>r.json()).then(data=>{
      const list = document.getElementById('notification-list'); list.innerHTML='';
      data.slice(0,5).forEach(item=>{ const li=document.createElement('li'); li.textContent=item.message; list.appendChild(li); });
    }).catch(()=>{ document.getElementById('notification-list').innerHTML='<li>Failed to load notifications.</li>' });

  </script>

  <script>
    (function(){
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;

      // DOM
      const scoreEl = document.getElementById('score');
      const highEl = document.getElementById('high');
      const comboEl = document.getElementById('combo');
      const overlay = document.getElementById('overlay');
      const hudMsg = document.getElementById('hudMsg');
      const restartBtn = document.getElementById('restartBtn');
      const muteBtn = document.getElementById('muteBtn');

      // audio tone helper
      let muted = localStorage.getItem('kk_muted') === 'true';
      muteBtn.textContent = muted ? 'ðŸ”‡' : 'ðŸ”Š';
      function playTone(freq, dur=80, vol=0.06){
        if(muted) return;
        try{
          const A = window.__audioCtx || (window.__audioCtx = new (window.AudioContext||window.webkitAudioContext)());
          const o = A.createOscillator();
          const g = A.createGain();
          o.type = 'sine'; o.frequency.value = freq;
          g.gain.value = vol;
          o.connect(g); g.connect(A.destination);
          o.start();
          g.gain.exponentialRampToValueAtTime(0.0001, A.currentTime + dur/1000);
          o.stop(A.currentTime + dur/1000 + 0.02);
        }catch(e){}
      }

      // State
      let running = true, gameOver = false;
      let score = 0;
      let high = parseInt(localStorage.getItem('kk_hs')||'0',10) || 0;
      highEl.textContent = high;
      let combo = 1, comboTimer = 0;

      // Player (circular)
      const player = { x:140, y:H-80, vy:0, r:20, onGround:false, jumpCount:0 };
      const gravity = 0.95;
      const TOP_LIMIT = 48;
      const jumpStrength = [15,12,9,6]; // 4 jumps decreasing

      // Obstacles
      let obstacles = [];
      let spawnTimer = 60;
      const baseSpeed = 3.2;
      let speed = baseSpeed;
      let frames = 0;

      // particles & background lights
      let particles = [];
      const bgLights = [];
      for(let i=0;i<48;i++){
        bgLights.push({
          x: Math.random()*W,
          y: Math.random()*H,
          r: Math.random()*2 + 0.6,
          vy: Math.random()*0.35 + 0.05,
          alpha: Math.random()*0.5 + 0.12
        });
      }

      function rand(a,b){ return a + Math.random()*(b-a); }
      function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

      // rect-circle intersection
      function rectIntersect(px,py,r,ox,oy,ow,oh){
        const closestX = Math.max(ox, Math.min(px, ox+ow));
        const closestY = Math.max(oy, Math.min(py, oy+oh));
        const dx = px - closestX, dy = py - closestY;
        return (dx*dx + dy*dy) < (r*r);
      }

      // spawn obstacle (bench or books)
      function spawn(){
        const h = Math.floor(rand(36,120));
        const type = Math.random() < 0.62 ? 'bench' : 'books';
        const w = type === 'bench' ? Math.floor(rand(56,90)) : Math.floor(rand(40,56));
        obstacles.push({ x: W + 40, w, h, type, passed:false });
      }

      // particles
      function createExplosion(x,y,count){
        for(let i=0;i<count;i++){
          particles.push({
            x, y,
            vx: rand(-6,6),
            vy: rand(-6,6),
            life: Math.floor(rand(20,60)),
            sz: rand(2,5),
            col: `hsl(${Math.floor(rand(30,60))},70%,60%)`
          });
        }
      }
      function pushJumpParticles(x,y,qty=8){
        for(let i=0;i<qty;i++){
          particles.push({
            x, y,
            vx: rand(-2.5,2.5),
            vy: rand(-4,-1),
            life: Math.floor(rand(18,34)),
            sz: rand(1.5,3),
            col: '#ffd04b'
          });
        }
      }

      // restart
      function restart(){
        score = 0;
        combo = 1;
        comboTimer = 0;
        obstacles = [];
        particles = [];
        player.y = H - 28 - player.r;
        player.vy = 0;
        player.jumpCount = 0;
        player.onGround = true;
        speed = baseSpeed;
        gameOver = false;
        running = true;
        frames = 0;
        spawnTimer = rand(36,90);
        hudMsg.textContent = 'Ready! Click / Space to play';
      }

      restartBtn.addEventListener('click', restart);
      muteBtn.addEventListener('click', ()=>{
        muted = !muted;
        localStorage.setItem('kk_muted', muted ? 'true' : 'false');
        muteBtn.textContent = muted ? 'ðŸ”‡' : 'ðŸ”Š';
      });

      // jump (up to 4)
      function doJump(){
        if(gameOver){ handleGameOverClick(); return; }
        if(player.onGround){
          player.vy = -jumpStrength[0];
          player.jumpCount = 1;
          player.onGround = false;
          playTone(560,70,0.06);
          pushJumpParticles(player.x, player.y + player.r, 10);
        } else {
          if(player.jumpCount < jumpStrength.length){
            const idx = player.jumpCount;
            player.vy = -jumpStrength[idx];
            player.jumpCount++;
            playTone(420 - idx*30,70,0.045);
            pushJumpParticles(player.x, player.y + player.r/2, 6);
          }
        }
      }
      window.addEventListener('keydown', e=>{ if(e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); doJump(); }});
      canvas.addEventListener('pointerdown', doJump);

      // game over click handler
      function handleGameOverClick(){
        running = false;
        if(Math.floor(score) > 0){
          const prevBest = parseInt(localStorage.getItem('kk_hs')||'0',10) || 0;
          if(Math.floor(score) > prevBest) localStorage.setItem('kk_hs', Math.floor(score));
          setTimeout(()=>{
            const name = prompt('Game over! Enter your name for leaderboard (or Cancel to skip):', 'Player');
            if(name !== null && name.trim() !== '') pushScoreToFirebase(name.trim(), Math.floor(score));
          }, 80);
        }
      }

      // update
      function update(){
        if(!running || gameOver) return;
        frames++;
        speed = baseSpeed + Math.min(frames / 1200, 6);

        spawnTimer -= 1 + Math.min(score/200, 1.8);
        if(spawnTimer <= 0){
          spawn();
          spawnTimer = Math.max(36, Math.floor(rand(48 - Math.min(frames/600,20), 110 - Math.min(frames/600,30))));
        }

        // player physics
        player.vy += gravity;
        player.y += player.vy;
        if(player.y < TOP_LIMIT){ player.y = TOP_LIMIT; player.vy = Math.max(0, player.vy); }
        if(player.y + player.r > H - 28){
          player.y = H - 28 - player.r;
          player.vy = 0;
          player.onGround = true;
          player.jumpCount = 0;
        } else player.onGround = false;

        // obstacles
        for(let i=obstacles.length-1;i>=0;i--){
          const ob = obstacles[i];
          ob.x -= speed;
          if(!ob.passed && ob.x + ob.w < player.x){
            ob.passed = true;
            score += Math.floor(12 * combo);
            combo += 0.18;
            comboTimer = 110;
            playTone(260 + Math.min(score,1200), 50, 0.04);
          }
          if(ob.x + ob.w < -120) obstacles.splice(i,1);
          const ox = ob.x, oy = H - 28 - ob.h;
          if(rectIntersect(player.x, player.y, player.r, ox, oy, ob.w, ob.h)){
            const landingThreshold = 3.5;
            const topY = H - 28 - ob.h - player.r;
            if(player.vy > landingThreshold && player.y < topY + player.r*0.6){
              // hard hit -> game over
              gameOver = true;
              running = false;
              playTone(120,260,0.18);
              createExplosion(player.x, player.y, 28);
              hudMsg.textContent = 'Game Over - click to save & restart';
            } else {
              // soft landing on top
              score += Math.floor(30 * combo);
              comboTimer = 120;
              playTone(760,90,0.06);
              player.vy = -9;
              for(let j=0;j<6;j++){
                particles.push({ x: player.x + rand(-6,6), y: player.y + player.r/2, vx: rand(-1,1), vy: rand(-3,-1), life: Math.floor(rand(20,36)), sz: rand(2,3), col: '#ffd04b' });
              }
            }
          }
        }

        // combo decay
        if(comboTimer > 0) comboTimer--; else combo = Math.max(1, combo - 0.04);

        // particles update
        for(let i=particles.length-1;i>=0;i--){
          const p = particles[i];
          p.vy += 0.25;
          p.x += p.vx;
          p.y += p.vy;
          p.life--;
          if(p.life <= 0) particles.splice(i,1);
        }

        // bg lights
        for(let i=0;i<bgLights.length;i++){
          const l = bgLights[i];
          l.y += l.vy;
          if(l.y > H + 8){ l.y = -8; l.x = Math.random()*W; }
        }

        // passive score
        if(running && !gameOver) score += 0.16 * Math.max(1, combo);

        // UI
        scoreEl.textContent = Math.floor(score);
        comboEl.textContent = 'x' + Math.max(1, combo.toFixed(1));
        const sc = Math.floor(score);
        if(sc > high){ high = sc; highEl.textContent = high; localStorage.setItem('kk_hs', high); }
      }

      // draw
      function draw(){
        ctx.clearRect(0,0,W,H);
        const g = ctx.createLinearGradient(0,0,0,H);
        g.addColorStop(0,'#0b4b5f'); g.addColorStop(1,'#02202b');
        ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

        // bg lights
        for(let i=0;i<bgLights.length;i++){
          const l = bgLights[i];
          ctx.globalAlpha = l.alpha;
          ctx.fillStyle = '#a8f0ff';
          ctx.beginPath();
          ctx.arc(l.x, l.y, l.r, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;

        // ground
        ctx.fillStyle = '#071827'; ctx.fillRect(0,H-28,W,28);

        // obstacles
        obstacles.forEach(ob=>{
          const ox = ob.x, oy = H - 28 - ob.h;
          if(ob.type === 'bench'){
            ctx.fillStyle = '#8b5e3c'; ctx.fillRect(ox, oy, ob.w, ob.h);
            ctx.fillStyle = '#5b3e2b'; ctx.fillRect(ox, oy + ob.h - 8, ob.w, 8);
            ctx.fillStyle = '#2b1f16'; ctx.fillRect(ox+6, oy+ob.h, 8, 12); ctx.fillRect(ox+ob.w-14, oy+ob.h, 8, 12);
          } else {
            for(let j=0;j<3;j++){
              const hh = ob.h/3;
              ctx.fillStyle = `hsl(${30 + j*20},60%,${40 - j*6}%)`;
              ctx.fillRect(ox, oy + j*hh, ob.w, hh-3);
              ctx.strokeStyle = 'rgba(0,0,0,0.18)';
              ctx.strokeRect(ox, oy + j*hh, ob.w, hh-3);
            }
          }
        });

        // player shadow (dim when on ground)
        ctx.save();
        ctx.globalAlpha = player.onGround ? 0.28 : 0.12;
        ctx.fillStyle = '#000';
        ctx.beginPath();
        ctx.ellipse(player.x + 6, H - 28 - player.r/2 + 6, player.r*1.1, player.r*0.45, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        // player (circle) - bright midair, dim on ground
        ctx.save();
        ctx.translate(player.x, player.y);
        ctx.rotate((player.vy || 0) * 0.02);
        ctx.beginPath();
        ctx.fillStyle = player.onGround ? '#e6c562' : '#ffd75a';
        ctx.arc(0, 0, player.r, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#2b3440';
        ctx.fillRect(-player.r*0.55, -player.r*0.6, player.r*1.1, player.r*0.32);
        ctx.restore();

        // particles
        particles.forEach(p=>{
          ctx.globalAlpha = Math.max(0, p.life / 60);
          ctx.beginPath();
          ctx.fillStyle = p.col || '#ffd04b';
          ctx.arc(p.x, p.y, p.sz, 0, Math.PI*2);
          ctx.fill();
        });
        ctx.globalAlpha = 1;

        overlay.innerHTML = `Speed: ${speed.toFixed(2)} <br> Obstacles: ${obstacles.length}`;

        if(gameOver){
          ctx.fillStyle = 'rgba(0,0,0,0.45)'; ctx.fillRect(0,0,W,H);
          ctx.fillStyle = '#fff'; ctx.font = '700 36px Inter, Roboto'; ctx.textAlign = 'center';
          ctx.fillText('Game Over', W/2, H/2 - 20);
          ctx.font = '600 18px Inter, Roboto';
          ctx.fillText('Click canvas to save score and restart', W/2, H/2 + 18);
        }
      }

      // main loop
      (function mainLoop(){
        update();
        draw();
        requestAnimationFrame(mainLoop);
      })();

      // canvas click when gameOver -> save & restart
      canvas.addEventListener('pointerdown', ()=>{
        if(gameOver){
          const name = prompt('Enter name to save score (or Cancel to skip):','Player');
          if(name !== null && name.trim() !== ''){
            if(Math.floor(score) > 0) pushScoreToFirebase(name.trim(), Math.floor(score));
          }
          restart();
        }
      });

      // responsive fit: scale CSS height to maintain aspect ratio
      function fitCanvas(){
        const box = canvas.getBoundingClientRect();
        const desiredHeight = box.width * (H / W);
        canvas.style.height = Math.round(desiredHeight) + 'px';
      }
      window.addEventListener('resize', fitCanvas);
      fitCanvas();

      // initial HUD and load high
      hudMsg.textContent = 'Tip: You have 4 jumps. Each one smaller than previous.';
      (function init(){ const hs = parseInt(localStorage.getItem('kk_hs')||'0',10) || 0; if(hs){ high = hs; highEl.textContent = high; } })();

      // pause when tab hidden
      document.addEventListener('visibilitychange', ()=>{ if(document.hidden) running = false; else if(!gameOver) running = true; });

    })();

    // small util
    function escapeHtml(unsafe){
      return String(unsafe).replace(/[&<>"']/g, function(m){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m];
      });
    }

    // load leaderboard once at start
    fetchLeaderboard();
  </script>
</body>
</html>
